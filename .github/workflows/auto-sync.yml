name: ğŸ”„ Auto Sync Disposable Email Domains

on:
  schedule:
    # Run twice daily at 6:05 AM and 6:05 PM UTC
    # Using minute offset (5) to avoid GitHub Actions queue saturation at top of the hour
    # This helps ensure the workflow runs reliably at scheduled times
    - cron: '5 6,18 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        type: boolean
        description: 'Force sync even if no changes detected'
        required: false
        default: false
      skip_auto_merge:
        type: boolean
        description: 'Skip automatic merge (create PR only)'
        required: false
        default: false
      custom_branch:
        type: string
        description: 'Custom branch name for sync'
        required: false
        default: ''

concurrency:
  group: auto-sync
  cancel-in-progress: false

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  FORCE_COLOR: 3
  NODE_ENV: production

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write

jobs:
  # ========================================
  # SYNC DOMAINS
  # ========================================
  sync:
    name: ğŸ”„ Sync Disposable Email Domains
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      domains_count: ${{ steps.sync_stats.outputs.domains_count }}
      new_domains: ${{ steps.sync_stats.outputs.new_domains }}
      removed_domains: ${{ steps.sync_stats.outputs.removed_domains }}
      success_rate: ${{ steps.sync_stats.outputs.success_rate }}
      processing_time: ${{ steps.sync_stats.outputs.processing_time }}
      failed_repos: ${{ steps.sync_stats.outputs.failed_repos }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      sync_branch: ${{ steps.create_branch.outputs.branch_name }}

    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Dependencies
        run: |
          bun install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ”§ Setup Git Configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ğŸŒ¿ Create Sync Branch
        id: create_branch
        run: |
          timestamp=$(date +"%Y%m%d-%H%M%S")
          if [ -n "${{ github.event.inputs.custom_branch }}" ]; then
            branch_name="${{ github.event.inputs.custom_branch }}"
          else
            branch_name="auto-sync/domains-${timestamp}"
          fi
          
          echo "branch_name=${branch_name}" >> $GITHUB_OUTPUT
          echo "ğŸŒ¿ Creating branch: ${branch_name}"
          
          git checkout -b "${branch_name}"
          git push -u origin "${branch_name}"

      - name: ğŸ“Š Backup Current Data
        run: |
          mkdir -p backup
          if [ -f "data/domains.json" ]; then
            cp data/domains.json backup/domains-pre-sync.json
            echo "âœ… Backed up current domains.json"
          fi
          if [ -f "data/stats.json" ]; then
            cp data/stats.json backup/stats-pre-sync.json
            echo "âœ… Backed up current stats.json"
          fi

      - name: ğŸ”„ Execute Domain Sync
        id: sync_domains
        run: |
          echo "ğŸš€ Starting domain synchronization..."
          
          # Run the sync with verbose output and capture the result
          if bun run src/syncer/cli.ts --verbose --timeout 45000 --concurrency 8 --retries 5; then
            echo "sync_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Domain sync completed successfully"
          else
            echo "sync_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Domain sync failed"
            exit 1
          fi

      - name: ğŸ“ˆ Extract Sync Statistics
        id: sync_stats
        run: |
          if [ -f "data/stats.json" ]; then
            # Parse stats using jq for reliable JSON processing
            domains_count=$(jq -r '.uniqueDomains // 0' data/stats.json)
            new_domains=$(jq -r '.newDomains // 0' data/stats.json)
            removed_domains=$(jq -r '.removedDomains // 0' data/stats.json)
            processing_time=$(jq -r '.processingTime // 0' data/stats.json)
            successful_downloads=$(jq -r '.successfulDownloads // 0' data/stats.json)
            total_repositories=$(jq -r '.totalRepositories // 1' data/stats.json)
            failed_downloads=$(jq -r '.failedDownloads // 0' data/stats.json)
            
            # Calculate success rate
            if [ "$total_repositories" -gt 0 ]; then
              success_rate=$(echo "scale=1; $successful_downloads * 100 / $total_repositories" | bc -l)
            else
              success_rate="0.0"
            fi
            
            # Get failed repository details
            failed_repos=$(jq -r '[.repositoryStats[] | select(.success == false) | .url] | join(", ")' data/stats.json 2>/dev/null || echo "")
            
            echo "domains_count=${domains_count}" >> $GITHUB_OUTPUT
            echo "new_domains=${new_domains}" >> $GITHUB_OUTPUT
            echo "removed_domains=${removed_domains}" >> $GITHUB_OUTPUT
            echo "success_rate=${success_rate}" >> $GITHUB_OUTPUT
            echo "processing_time=${processing_time}" >> $GITHUB_OUTPUT
            echo "failed_repos=${failed_repos}" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š Sync Statistics:"
            echo "   â€¢ Total domains: ${domains_count}"
            echo "   â€¢ New domains: ${new_domains}" 
            echo "   â€¢ Removed domains: ${removed_domains}"
            echo "   â€¢ Success rate: ${success_rate}%"
            echo "   â€¢ Processing time: ${processing_time}ms"
          else
            echo "âš ï¸ Stats file not found, using default values"
            echo "domains_count=0" >> $GITHUB_OUTPUT
            echo "new_domains=0" >> $GITHUB_OUTPUT
            echo "removed_domains=0" >> $GITHUB_OUTPUT
            echo "success_rate=0.0" >> $GITHUB_OUTPUT
            echo "processing_time=0" >> $GITHUB_OUTPUT
            echo "failed_repos=" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Update README Statistics
        if: steps.execute_sync.outputs.success == 'true'
        run: |
          echo "ğŸ“Š Updating README with latest statistics..."
          
          # Run the README stats update script
          if ./scripts/update-readme-stats.sh; then
            echo "âœ… README statistics updated successfully"
          else
            echo "âš ï¸ README update failed, but continuing with sync process"
          fi

      - name: ğŸ” Check for Changes
        id: check_changes
        run: |
          git add .
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected in domain data"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in domain data"
            
            # Show what changed
            echo "ğŸ“‹ Changed files:"
            git diff --cached --name-only | sed 's/^/   â€¢ /'
          fi

      - name: ğŸ“ Commit Changes
        if: steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          timestamp=$(date -Iseconds)
          
          git add .
          git commit -m "ğŸ”„ Auto-sync: Update disposable email domains

          ğŸ“Š Sync Summary:
          â€¢ Total domains: ${{ steps.sync_stats.outputs.domains_count }}
          â€¢ New domains added: ${{ steps.sync_stats.outputs.new_domains }}
          â€¢ Domains removed: ${{ steps.sync_stats.outputs.removed_domains }}
          â€¢ Repository success rate: ${{ steps.sync_stats.outputs.success_rate }}%
          â€¢ Processing time: ${{ steps.sync_stats.outputs.processing_time }}ms
          â€¢ Sync timestamp: ${timestamp}
          
          Generated by GitHub Actions Auto-Sync Workflow
          Branch: ${{ steps.create_branch.outputs.branch_name }}
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}"
          
          git push origin "${{ steps.create_branch.outputs.branch_name }}"
          echo "âœ… Changes committed and pushed"

      - name: ğŸ¯ Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const timestamp = new Date().toISOString();
            const processingTimeSeconds = (${{ steps.sync_stats.outputs.processing_time }} / 1000).toFixed(2);
            
            // Generate detailed PR body with statistics and analysis
            const prBody = `## ğŸ”„ Automated Disposable Email Domains Sync
            
            This PR contains the latest synchronization of disposable email domains from configured sources.
            
            ### ğŸ“Š Sync Statistics
            
            | Metric | Value |
            |--------|-------|
            | ğŸ“§ **Total Domains** | **${{ steps.sync_stats.outputs.domains_count }}** |
            | ğŸ†• **New Domains** | **${{ steps.sync_stats.outputs.new_domains }}** |
            | ğŸ—‘ï¸ **Removed Domains** | **${{ steps.sync_stats.outputs.removed_domains }}** |
            | â±ï¸ **Processing Time** | **${processingTimeSeconds}s** |
            | âœ… **Success Rate** | **${{ steps.sync_stats.outputs.success_rate }}%** |
            | ğŸ• **Sync Time** | ${timestamp} |
            
            ### ğŸ“ˆ Change Analysis
            
            ${${{ steps.sync_stats.outputs.new_domains }} > 0 ? 
              'ğŸ‰ **Domain Growth**: ' + ${{ steps.sync_stats.outputs.new_domains }} + ' new disposable email domains detected and added.' : 
              'ğŸ“Š **No New Domains**: No new domains were found in this sync cycle.'
            }
            
            ${${{ steps.sync_stats.outputs.removed_domains }} > 0 ? 
              'ğŸ§¹ **Cleanup**: ' + ${{ steps.sync_stats.outputs.removed_domains }} + ' domains were removed (likely no longer active or moved to allowlist).' : 
              'âœ¨ **No Removals**: All existing domains remain valid.'
            }
            
            ### ğŸ” Repository Status
            
            ${${{ steps.sync_stats.outputs.success_rate }} >= 90 ? 
              'âœ… **Excellent**: All repositories synced successfully!' : 
              ${{ steps.sync_stats.outputs.success_rate }} >= 80 ? 
                'âš ï¸ **Good**: Most repositories synced successfully with minor issues.' :
                'âŒ **Attention Needed**: Multiple repositories failed to sync.'
            }
            
            ${`${{ steps.sync_stats.outputs.failed_repos }}`.length > 0 ? 
              '#### âš ï¸ Failed Repositories\n\nThe following repositories failed to sync:\n' +
              `${{ steps.sync_stats.outputs.failed_repos }}`.split(', ').map(url => url ? 'â€¢ ' + url : '').filter(Boolean).join('\n') +
              '\n\nğŸ’¡ **Action Required**: These failures should be investigated to ensure complete domain coverage.' :
              '#### âœ… All Repositories Successful\n\nAll configured repositories were successfully synchronized.'
            }
            
            ### ğŸ¤– Automation Details
            
            - **Workflow**: \`${{ github.workflow }}\`
            - **Branch**: \`${{ steps.create_branch.outputs.branch_name }}\`
            - **Run ID**: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Trigger**: ${context.eventName === 'schedule' ? 'Scheduled execution' : 'Manual trigger'}
            
            ### ğŸ“ Updated Files
            
            - \`data/domains.txt\` - Plain text domain list
            - \`data/domains.json\` - JSON format with metadata
            - \`data/stats.json\` - Detailed synchronization statistics
            - \`data/report.md\` - Human-readable sync report
            
            ---
            
            **ğŸ”„ This PR will be automatically merged** if all checks pass and no conflicts are detected.
            
            To prevent auto-merge, add the \`hold\` label to this PR.
            `;
            
            try {
              const { data: pullRequest } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ”„ Auto-sync: Update disposable email domains (+${{ steps.sync_stats.outputs.new_domains }}, -${{ steps.sync_stats.outputs.removed_domains }})`,
                head: '${{ steps.create_branch.outputs.branch_name }}',
                base: 'master',
                body: prBody,
                maintainer_can_modify: true
              });
              
              console.log(`âœ… Pull request created: #${pullRequest.number}`);
              core.setOutput('pr_number', pullRequest.number);
              
              // Add labels based on sync results
              const labels = ['auto-sync', 'domains-update'];
              
              if (${{ steps.sync_stats.outputs.new_domains }} > 0) {
                labels.push('enhancement');
              }
              
              if (${{ steps.sync_stats.outputs.success_rate }} < 90) {
                labels.push('needs-review');
              }
              
              if (${{ steps.sync_stats.outputs.new_domains }} > 100) {
                labels.push('major-update');
              }
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullRequest.number,
                labels: labels
              });
              
              return pullRequest.number;
            } catch (error) {
              core.setFailed(`Failed to create pull request: ${error.message}`);
              throw error;
            }

  # ========================================
  # QUALITY CHECKS
  # ========================================
  quality_checks:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    needs: sync
    if: needs.sync.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
    timeout-minutes: 10

    steps:
      - name: ğŸš€ Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.sync.outputs.sync_branch }}
          fetch-depth: 1

      - name: ğŸ—ï¸ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ§ª Run Tests
        run: |
          echo "ğŸ§ª Running test suite..."
          bun test --coverage --reporter=verbose

      - name: ğŸ” Validate Domain Format
        run: |
          echo "ğŸ” Validating domain format and integrity..."
          
          # Check if domains.txt exists and is not empty
          if [ ! -s "data/domains.txt" ]; then
            echo "âŒ domains.txt is empty or missing"
            exit 1
          fi
          
          # Check for basic domain format validity
          invalid_domains=$(grep -E -v '^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$' data/domains.txt | head -5)
          
          if [ -n "$invalid_domains" ]; then
            echo "âš ï¸ Found potentially invalid domains:"
            echo "$invalid_domains"
            echo "â„¹ï¸ This might be acceptable for some edge cases, continuing..."
          fi
          
          # Check for duplicates
          duplicates=$(sort data/domains.txt | uniq -d | head -3)
          if [ -n "$duplicates" ]; then
            echo "âŒ Found duplicate domains:"
            echo "$duplicates"
            exit 1
          fi
          
          # Validate JSON structure
          if [ -f "data/domains.json" ]; then
            if jq empty data/domains.json; then
              echo "âœ… domains.json is valid JSON"
            else
              echo "âŒ domains.json contains invalid JSON"
              exit 1
            fi
          fi
          
          echo "âœ… Domain validation completed successfully"

      - name: ğŸ“Š Generate Quality Report
        run: |
          echo "ğŸ“Š Generating quality assurance report..."
          
          total_domains=$(wc -l < data/domains.txt)
          json_domains=$(jq '.domains | length' data/domains.json 2>/dev/null || echo "0")
          
          echo "## ğŸ” Quality Assurance Report" > qa_report.md
          echo "" >> qa_report.md
          echo "- **Total Domains in TXT**: $total_domains" >> qa_report.md
          echo "- **Total Domains in JSON**: $json_domains" >> qa_report.md
          echo "- **Format Consistency**: $([ "$total_domains" -eq "$json_domains" ] && echo "âœ… Consistent" || echo "âš ï¸ Mismatch detected")" >> qa_report.md
          echo "- **File Sizes**:" >> qa_report.md
          echo "  - domains.txt: $(stat -f%z data/domains.txt 2>/dev/null || stat -c%s data/domains.txt) bytes" >> qa_report.md
          echo "  - domains.json: $(stat -f%z data/domains.json 2>/dev/null || stat -c%s data/domains.json) bytes" >> qa_report.md
          echo "" >> qa_report.md
          echo "_Report generated at $(date -Iseconds)_" >> qa_report.md
          
          cat qa_report.md
          echo "âœ… Quality report generated"

  # ========================================
  # AUTO MERGE
  # ========================================
  auto_merge:
    name: ğŸš€ Auto Merge
    runs-on: ubuntu-latest
    needs: [sync, quality_checks]
    if: |
      always() && 
      needs.sync.result == 'success' && 
      needs.quality_checks.result == 'success' &&
      github.event.inputs.skip_auto_merge != 'true' &&
      (needs.sync.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true')
    timeout-minutes: 5

    steps:
      - name: ğŸ” Check PR Status
        id: pr_status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ needs.sync.outputs.pr_number }};
            
            try {
              // Get PR details
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              console.log(`ğŸ“‹ PR #${prNumber} status: ${pr.state}`);
              console.log(`ğŸ”„ Mergeable: ${pr.mergeable}`);
              console.log(`ğŸ·ï¸ Labels: ${pr.labels.map(l => l.name).join(', ')}`);
              
              // Check if PR has 'hold' label
              const hasHoldLabel = pr.labels.some(label => label.name === 'hold');
              
              if (hasHoldLabel) {
                console.log('â¸ï¸ PR has "hold" label - skipping auto-merge');
                core.setOutput('should_merge', 'false');
                core.setOutput('skip_reason', 'hold_label');
                return;
              }
              
              if (pr.state !== 'open') {
                console.log('âŒ PR is not open - cannot merge');
                core.setOutput('should_merge', 'false');
                core.setOutput('skip_reason', 'not_open');
                return;
              }
              
              if (pr.mergeable === false) {
                console.log('âŒ PR has conflicts - cannot auto-merge');
                core.setOutput('should_merge', 'false');
                core.setOutput('skip_reason', 'conflicts');
                return;
              }
              
              console.log('âœ… PR is ready for auto-merge');
              core.setOutput('should_merge', 'true');
              core.setOutput('pr_title', pr.title);
              
            } catch (error) {
              console.error(`âŒ Failed to check PR status: ${error.message}`);
              core.setOutput('should_merge', 'false');
              core.setOutput('skip_reason', 'api_error');
            }

      - name: ğŸš€ Merge Pull Request
        if: steps.pr_status.outputs.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ needs.sync.outputs.pr_number }};
            
            try {
              // Add a comment before merging
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ğŸ¤– **Auto-Merge Initiated**
                
                Quality checks passed successfully:
                âœ… Domain sync completed
                âœ… Format validation passed  
                âœ… No conflicts detected
                âœ… Tests passed
                
                Proceeding with automatic merge...`
              });
              
              // Merge the PR
              const { data: merge } = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                commit_title: `ğŸ”„ Auto-merge: ${{ steps.pr_status.outputs.pr_title }}`,
                commit_message: `Automatically merged PR #${prNumber} after successful quality checks.
                
                ğŸ“Š Sync Results:
                â€¢ Total domains: ${{ needs.sync.outputs.domains_count }}
                â€¢ New domains: ${{ needs.sync.outputs.new_domains }}
                â€¢ Removed domains: ${{ needs.sync.outputs.removed_domains }}
                â€¢ Success rate: ${{ needs.sync.outputs.success_rate }}%
                
                ğŸ¤– Merged by GitHub Actions Auto-Sync Workflow`,
                merge_method: 'squash'
              });
              
              console.log(`âœ… Successfully merged PR #${prNumber}`);
              console.log(`ğŸ“ Merge SHA: ${merge.sha}`);
              
              // Clean up the sync branch
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${{ needs.sync.outputs.sync_branch }}`
                });
                console.log(`ğŸ§¹ Cleaned up branch: ${{ needs.sync.outputs.sync_branch }}`);
              } catch (cleanupError) {
                console.log(`âš ï¸ Could not clean up branch: ${cleanupError.message}`);
              }
              
            } catch (error) {
              console.error(`âŒ Failed to merge PR: ${error.message}`);
              
              // Add error comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âŒ **Auto-Merge Failed**
                
                Error: ${error.message}
                
                Manual intervention required. Please review and merge manually if appropriate.`
              });
              
              throw error;
            }

      - name: â„¹ï¸ Skip Merge Notification
        if: steps.pr_status.outputs.should_merge != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ needs.sync.outputs.pr_number }};
            const skipReason = '${{ steps.pr_status.outputs.skip_reason }}';
            
            let message = 'â¸ï¸ **Auto-Merge Skipped**\n\n';
            
            switch (skipReason) {
              case 'hold_label':
                message += 'ğŸ·ï¸ This PR has the "hold" label, preventing automatic merge.\n\nRemove the label to enable auto-merge, or merge manually when ready.';
                break;
              case 'conflicts':
                message += 'âš”ï¸ This PR has merge conflicts that need to be resolved.\n\nPlease resolve conflicts and the workflow will attempt auto-merge again.';
                break;
              case 'not_open':
                message += 'ğŸ“‹ This PR is not in an open state.\n\nNo action needed.';
                break;
              default:
                message += `ğŸ¤” Reason: ${skipReason}\n\nPlease review the PR status and merge manually if appropriate.`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });

  # ========================================
  # NOTIFICATION & CLEANUP
  # ========================================
  notify:
    name: ğŸ“¢ Post-Sync Notifications
    runs-on: ubuntu-latest
    needs: [sync, quality_checks, auto_merge]
    if: always() && needs.sync.result == 'success'
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Generate Final Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const syncResult = '${{ needs.sync.result }}';
            const qaResult = '${{ needs.quality_checks.result }}';
            const mergeResult = '${{ needs.auto_merge.result }}';
            const hasChanges = '${{ needs.sync.outputs.has_changes }}';
            
            console.log('ğŸ“Š Auto-Sync Workflow Summary');
            console.log('================================');
            console.log(`ğŸ”„ Sync: ${syncResult}`);
            console.log(`ğŸ” Quality Checks: ${qaResult}`);
            console.log(`ğŸš€ Auto Merge: ${mergeResult}`);
            console.log(`ğŸ“ Changes Detected: ${hasChanges}`);
            console.log(`ğŸ“§ Total Domains: ${{ needs.sync.outputs.domains_count }}`);
            console.log(`ğŸ†• New Domains: ${{ needs.sync.outputs.new_domains }}`);
            console.log(`ğŸ—‘ï¸ Removed Domains: ${{ needs.sync.outputs.removed_domains }}`);
            console.log(`âœ… Success Rate: ${{ needs.sync.outputs.success_rate }}%`);
            
            if (hasChanges === 'true') {
              console.log(`ğŸ”— PR: #${{ needs.sync.outputs.pr_number }}`);
            } else {
              console.log('â„¹ï¸ No changes detected - no PR created');
            }
            
            // Create a workflow summary
            const summary = `## ğŸ”„ Disposable Email Domains Auto-Sync Summary
            
            | Status | Result |
            |--------|---------|
            | ğŸ”„ **Domain Sync** | ${syncResult === 'success' ? 'âœ… Success' : 'âŒ Failed'} |
            | ğŸ” **Quality Checks** | ${qaResult === 'success' ? 'âœ… Passed' : qaResult === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'} |
            | ğŸš€ **Auto Merge** | ${mergeResult === 'success' ? 'âœ… Merged' : mergeResult === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'} |
            
            ### ğŸ“ˆ Domain Statistics
            - **Total Domains**: ${{ needs.sync.outputs.domains_count }}
            - **New Domains**: ${{ needs.sync.outputs.new_domains }}
            - **Removed Domains**: ${{ needs.sync.outputs.removed_domains }}
            - **Repository Success Rate**: ${{ needs.sync.outputs.success_rate }}%
            - **Processing Time**: ${{ needs.sync.outputs.processing_time }}ms
            
            ${hasChanges === 'true' ? 
              `### ğŸ”— Pull Request\n- **PR Number**: #${{ needs.sync.outputs.pr_number }}\n- **Branch**: \`${{ needs.sync.outputs.sync_branch }}\`` : 
              '### â„¹ï¸ No Changes\nNo domain changes were detected in this sync cycle.'
            }`;
            
            await core.summary.addRaw(summary).write();

      - name: ğŸ  Cleanup Workflow Artifacts
        run: |
          echo "ğŸ§¹ Cleaning up temporary files and artifacts..."
          
          # Remove any temporary backup files older than 7 days
          find . -name "*-pre-sync.*" -type f -mtime +7 -delete 2>/dev/null || true
          
          echo "âœ… Cleanup completed"

